# mise configuration for tinywhale monorepo
[tools]
node = "24.13.0"
pnpm = "10.28.0"

[tasks.install]
description = "Install dependencies"
run = "pnpm install"

[tasks.update]
description = "Update all dependencies to latest versions"
run = "pnpm up -r --latest"

[tasks.update-interactive]
description = "Interactively select which dependencies to update"
run = "pnpm up -r --latest --interactive"

[tasks.generate-grammar]
description = "Generate Ohm grammar bundles with TypeScript types"
depends = ["clean"]
run = "cd packages/compiler && npx @ohm-js/cli generateBundles --withTypes --esm 'src/parse/*.ohm'"

[tasks.build]
description = "Build all packages"
depends = ["generate-grammar"]
run = "pnpm -r build"

[tasks.test]
description = "Run tests for all packages"
depends = ["build"]
run = "pnpm -r test"

[tasks.check]
description = "Run biome check (lint & format)"
depends = ["build"]
run = "pnpm -r exec biome check --write --max-diagnostics 100"

[tasks.ci]
description = "Run full CI pipeline: build, lint, typecheck, test"
hide = true
run = """
cd packages/compiler && npx @ohm-js/cli generateBundles --withTypes --esm 'src/parse/*.ohm'
pnpm -r build
pnpm exec biome check --max-diagnostics 100
pnpm exec tsc
pnpm -r test
"""

[tasks.typecheck]
description = "Run TypeScript type checking"
depends = ["build"]
run = "pnpm -r exec tsc"

[tasks.clean]
description = "Clean build artifacts"
run = "pnpm -r clean"

[tasks.cli]
description = "Run the TinyWhale CLI build command"
depends = ["build"]
usage = '''
arg "<file>" help="TinyWhale source file to compile"
flag "-o --output <dir>" help="Output directory"
flag "-t --target <format>" help="Output format: wasm or wat"
flag "--optimize" help="Run optimization passes"
'''
run = """
node packages/cli-compiler/dist/cli.js build ${usage_file?} \
  ${usage_output:+--output "$usage_output"} \
  ${usage_target:+--target "$usage_target"} \
  ${usage_optimize:+--optimize}
"""

[tasks.grammar-test]
description = "Run grammar tests"
depends = ["build"]
usage = '''
arg "[files]..." help="Test files to run (default: all)"
flag "-r --reporter <format>" help="Reporter format: spec, json, or tap"
'''
run = """
node packages/cli-grammar-test/dist/cli/index.js test \
  ${usage_reporter:+--reporter "$usage_reporter"} \
  ${usage_files}
"""

[tasks.grammar-analyze]
description = "Analyze grammar for issues"
depends = ["build"]
usage = '''
arg "<grammar>" help="Grammar file to analyze (.ohm)"
flag "-f --format <format>" help="Output format: spec or json"
'''
run = """
node packages/cli-grammar-test/dist/cli/index.js analyze \
  ${usage_format:+--format "$usage_format"} \
  ${usage_grammar?}
"""
